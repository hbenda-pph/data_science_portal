<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Datos y An치lisis (GCloud Ready)</title>
    <!-- Carga de Tailwind CSS para un dise침o moderno y responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configuraci칩n de Tailwind para un tema visual profesional (Inter font)
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'gcloud-blue': '#1a73e8',
                        'dark-bg': '#1e293b',
                        'card-bg': '#334155',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            }
        }

        const activeLinkClasses = ['bg-gray-100', 'dark:bg-slate-700', 'text-gcloud-blue'];
        const inactiveLinkClasses = ['text-gray-700', 'dark:text-gray-300', 'hover:bg-gray-100', 'dark:hover:bg-slate-700'];

        let appsCatalog = [];
        let categoryCounts = {};
        let activeCategory = 'Todos';

        document.addEventListener('DOMContentLoaded', () => {
            initThemeToggle();
            initPortal();
        });

        function initThemeToggle() {
            const toggle = document.getElementById('dark-mode-toggle');
            const root = document.documentElement;

            if (!toggle) {
                return;
            }

            if (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                root.classList.add('dark');
            }

            toggle.addEventListener('click', () => {
                root.classList.toggle('dark');
                if (root.classList.contains('dark')) {
                    localStorage.setItem('theme', 'dark');
                } else {
                    localStorage.setItem('theme', 'light');
                }
            });
        }

        async function initPortal() {
            const contentArea = document.getElementById('content-area');
            const navContainer = document.getElementById('sidebar-nav');

            if (!contentArea || !navContainer) {
                return;
            }

            contentArea.innerHTML = `
                <div class="flex items-center justify-center py-16 text-gray-500 dark:text-gray-400">
                    <span class="animate-pulse">Cargando cat치logo...</span>
                </div>
            `;

            try {
                const response = await fetch('/api/apps');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const payload = await response.json();
                appsCatalog = Array.isArray(payload.apps) ? payload.apps : [];
            } catch (error) {
                console.error('Error cargando cat치logo:', error);
                contentArea.innerHTML = `
                    <div class="bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-200 p-6 rounded-xl border border-red-200 dark:border-red-800">
                        <h2 class="text-lg font-semibold mb-2">No se pudo cargar el cat치logo</h2>
                        <p class="text-sm">Verifica que el endpoint <code class="font-mono">/api/apps</code> est칠 disponible o revisa los logs del servicio Flask.</p>
                    </div>
                `;
                navContainer.innerHTML = '';
                return;
            }

            categoryCounts = computeCategoryCounts(appsCatalog);
            const categories = buildCategoryList(appsCatalog);

            renderSidebar(navContainer, categories);
            activeCategory = categories[0] || 'Todos';
            setActiveLink(activeCategory);
            loadContent(activeCategory);
        }

        function computeCategoryCounts(catalog) {
            const counts = {};
            catalog.forEach(app => {
                const category = (app.category || 'Otros').trim() || 'Otros';
                counts[category] = (counts[category] || 0) + 1;
            });
            return counts;
        }

        function buildCategoryList(catalog) {
            const unique = new Set(['Todos']);
            catalog.forEach(app => {
                const category = (app.category || 'Otros').trim() || 'Otros';
                unique.add(category);
            });
            return Array.from(unique);
        }

        function renderSidebar(container, categories) {
            container.innerHTML = '';
            categories.forEach((category, index) => {
                const link = document.createElement('a');
                link.href = '#';
                link.dataset.category = category;
                link.classList.add('sidebar-link', 'flex', 'items-center', 'p-3', 'rounded-lg', 'text-sm', 'font-medium', 'transition', 'duration-150');

                if (index === 0) {
                    addActiveClasses(link);
                } else {
                    addInactiveClasses(link);
                }

                const count = category === 'Todos' ? appsCatalog.length : (categoryCounts[category] || 0);

                link.innerHTML = `
                    ${getCategoryIcon(category)}
                    <span class="flex-1">${category === 'Todos' ? 'Todos los proyectos' : category}</span>
                    <span class="text-xs text-gray-400 dark:text-gray-500">${count}</span>
                `;

                link.addEventListener('click', handleCategoryClick);
                container.appendChild(link);
            });
        }

        function handleCategoryClick(event) {
            event.preventDefault();
            const category = event.currentTarget.dataset.category;
            if (!category || category === activeCategory) {
                return;
            }
            activeCategory = category;
            setActiveLink(category);
            loadContent(category);
        }

        function setActiveLink(category) {
            document.querySelectorAll('.sidebar-link').forEach(link => {
                const isActive = link.dataset.category === category;
                link.classList.remove(...activeLinkClasses, ...inactiveLinkClasses);
                if (isActive) {
                    addActiveClasses(link);
                } else {
                    addInactiveClasses(link);
                }
            });
        }

        function addActiveClasses(element) {
            element.classList.add(...activeLinkClasses);
        }

        function addInactiveClasses(element) {
            element.classList.add(...inactiveLinkClasses);
        }

        function loadContent(category) {
            const contentArea = document.getElementById('content-area');
            if (!contentArea) {
                return;
            }

            if (!appsCatalog.length) {
                contentArea.innerHTML = `
                    <div class="bg-white dark:bg-slate-800 border border-dashed border-gray-300 dark:border-slate-700 rounded-xl p-10 text-center">
                        <h2 class="text-lg font-semibold mb-2">A칰n no hay proyectos registrados</h2>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Agrega entradas en <code class="font-mono text-gcloud-blue">apps_catalog.json</code> para comenzar.</p>
                    </div>
                `;
                return;
            }

            const filtered = category === 'Todos'
                ? appsCatalog
                : appsCatalog.filter(app => {
                    const cat = (app.category || 'Otros').trim() || 'Otros';
                    return cat === category;
                });

            if (!filtered.length) {
                contentArea.innerHTML = `
                    <div class="bg-white dark:bg-slate-800 border border-dashed border-gray-300 dark:border-slate-700 rounded-xl p-10 text-center">
                        <h2 class="text-lg font-semibold mb-2">Sin proyectos en esta categor칤a</h2>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Pronto habr치 aplicaciones para "${category}".</p>
                    </div>
                `;
                return;
            }

            const cardsHtml = filtered.map(renderAppCard).join('');
            const title = category === 'Todos' ? 'Todos los proyectos' : category;
            const countLabel = filtered.length === 1 ? '1 proyecto' : `${filtered.length} proyectos`;

            contentArea.innerHTML = `
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-900 dark:text-white">${title}</h2>
                        <p class="text-sm text-gray-600 dark:text-gray-400">${countLabel}</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                    ${cardsHtml}
                </div>
            `;
        }

        function renderAppCard(app) {
            const title = app.title || app.id || 'Proyecto sin t칤tulo';
            const summary = app.summary || 'Descripci칩n pendiente.';
            const category = app.category || 'Otros';
            const owner = app.owner || 'Equipo de Data Science';
            const lastUpdate = app.last_update || 'Sin fecha';
            const statusPill = renderStatusPill(app.status);
            const stackSection = renderStackChips(app.stack);
            const tagsSection = renderTags(app.tags);
            const envSection = renderEnvironmentChips(app.environments);
            const actionButton = renderPrimaryLink(app);

            return `
                <article class="data-card bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg border border-gray-100 dark:border-slate-700 hover:shadow-xl transition duration-300">
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-xs font-semibold uppercase tracking-wide text-gray-500 dark:text-gray-400">${category}</span>
                        ${statusPill}
                    </div>
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">${title}</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">${summary}</p>
                    ${stackSection ? `<div class="flex flex-wrap gap-2 mb-3">${stackSection}</div>` : ''}
                    ${tagsSection ? `<div class="flex flex-wrap gap-2 mb-3">${tagsSection}</div>` : ''}
                    <div class="mt-6 flex flex-col gap-4 text-sm">
                        <div class="text-gray-600 dark:text-gray-400">
                            <p><span class="font-semibold text-gray-700 dark:text-gray-200">Owner:</span> ${owner}</p>
                            <p><span class="font-semibold text-gray-700 dark:text-gray-200">Actualizaci칩n:</span> ${lastUpdate}</p>
                        </div>
                        ${envSection}
                        ${actionButton}
                    </div>
                </article>
            `;
        }

        function renderStatusPill(status) {
            const label = status || 'En progreso';
            const normalized = label.toLowerCase();
            let classes = 'bg-amber-100 text-amber-700';
            if (normalized.includes('activo') || normalized.includes('productivo')) {
                classes = 'bg-emerald-100 text-emerald-700';
            } else if (normalized.includes('pausado') || normalized.includes('mantenimiento')) {
                classes = 'bg-slate-200 text-slate-600';
            } else if (normalized.includes('pendiente')) {
                classes = 'bg-blue-100 text-blue-700';
            }
            return `<span class="px-2.5 py-1 rounded-full text-xs font-semibold ${classes}">${label}</span>`;
        }

        function renderStackChips(stack) {
            if (!Array.isArray(stack) || stack.length === 0) {
                return '';
            }
            return stack
                .map(item => `<span class="px-2 py-1 text-xs font-medium bg-slate-100 dark:bg-slate-700 dark:text-slate-200 text-slate-700 rounded-md">${item}</span>`)
                .join('');
        }

        function renderTags(tags) {
            if (!Array.isArray(tags) || tags.length === 0) {
                return '';
            }
            return tags
                .map(tag => `<span class="px-2 py-1 text-xs font-medium bg-gcloud-blue/10 text-gcloud-blue dark:bg-blue-500/20 dark:text-blue-200 rounded-md">${tag}</span>`)
                .join('');
        }

        function renderEnvironmentChips(environments) {
            if (!environments || typeof environments !== 'object') {
                return '';
            }
            const chips = Object.entries(environments).map(([key, value]) => {
                const label = (value && value.label) || key.toUpperCase();
                const url = value && value.url;
                if (url) {
                    return `<a href="${url}" target="_blank" rel="noopener noreferrer" class="px-3 py-1 text-xs font-semibold rounded-full border border-gcloud-blue text-gcloud-blue hover:bg-gcloud-blue hover:text-white transition" title="Abrir ${label}">${label}</a>`;
                }
                return `<span class="px-3 py-1 text-xs font-semibold rounded-full border border-gray-300 text-gray-400 cursor-not-allowed opacity-60" title="URL pendiente">${label}</span>`;
            });
            if (!chips.length) {
                return '';
            }
            return `<div class="flex flex-wrap gap-2 justify-start sm:justify-end">${chips.join('')}</div>`;
        }

        function renderPrimaryLink(app) {
            const primary = resolvePrimaryUrl(app);
            if (!primary) {
                return '';
            }
            return `
                <div>
                    <a href="${primary.url}" target="_blank" rel="noopener noreferrer"
                       class="inline-flex items-center px-4 py-2 text-sm font-semibold rounded-lg bg-gcloud-blue text-white hover:bg-blue-600 transition">
                        ${primary.label}
                    </a>
                </div>
            `;
        }

        function resolvePrimaryUrl(app) {
            if (app.primary_url) {
                return { label: '游 Abrir', url: app.primary_url };
            }
            if (app.environments && typeof app.environments === 'object') {
                for (const key of ['pro', 'qua', 'dev']) {
                    const env = app.environments[key];
                    if (env && env.url) {
                        return { label: `游 ${env.label}`, url: env.url };
                    }
                }
            }
            return null;
        }

        function getCategoryIcon(category) {
            const baseClass = 'h-5 w-5 mr-3 text-gray-500 dark:text-gray-400';
            const normalized = category.toLowerCase();
            if (category === 'Todos') {
                return `<svg xmlns="http://www.w3.org/2000/svg" class="${baseClass}" viewBox="0 0 20 20" fill="currentColor"><path d="M6 3a3 3 0 00-3 3v1a3 3 0 003 3h1a3 3 0 003-3V6a3 3 0 00-3-3H6zM6 11a3 3 0 00-3 3v1a3 3 0 003 3h1a3 3 0 003-3v-1a3 3 0 00-3-3H6zM12 3a3 3 0 00-3 3v1a3 3 0 003 3h1a3 3 0 003-3V6a3 3 0 00-3-3h-1zM12 11a3 3 0 00-3 3v1a3 3 0 003 3h1a3 3 0 003-3v-1a3 3 0 00-3-3h-1z"/></svg>`;
            }
            if (normalized.includes('dataset')) {
                return `<svg xmlns="http://www.w3.org/2000/svg" class="${baseClass}" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 3a2 2 0 012-2h8a2 2 0 012 2v3a2 2 0 01-2 2H6a2 2 0 01-2-2V3zm2 8a2 2 0 00-2 2v3a2 2 0 002 2h8a2 2 0 002-2v-3a2 2 0 00-2-2H6z" clip-rule="evenodd"/></svg>`;
            }
            if (normalized.includes('notebook')) {
                return `<svg xmlns="http://www.w3.org/2000/svg" class="${baseClass}" viewBox="0 0 20 20" fill="currentColor"><path d="M4 4a2 2 0 012-2h6.5a2 2 0 011.414.586l1.5 1.5A2 2 0 0116 5.914V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z"/><path d="M8 11h4a1 1 0 010 2H8a1 1 0 110-2zM8 7h4a1 1 0 010 2H8a1 1 0 110-2z"/></svg>`;
            }
            if (normalized.includes('modelo')) {
                return `<svg xmlns="http://www.w3.org/2000/svg" class="${baseClass}" viewBox="0 0 20 20" fill="currentColor"><path d="M11 17a1 1 0 001-1v-2.586l2.293 2.293a1 1 0 001.414-1.414L13.414 12H16a1 1 0 100-2h-2.586l2.293-2.293a1 1 0 10-1.414-1.414L11 8.586V6a1 1 0 10-2 0v2.586L6.707 6.293A1 1 0 105.293 7.707L7.586 10H5a1 1 0 100 2h2.586l-2.293 2.293a1 1 0 001.414 1.414L9 13.414V16a1 1 0 001 1z"/></svg>`;
            }
            if (normalized.includes('portal')) {
                return `<svg xmlns="http://www.w3.org/2000/svg" class="${baseClass}" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm0-4a4 4 0 100-8 4 4 0 000 8z" clip-rule="evenodd"/></svg>`;
            }
            return `<svg xmlns="http://www.w3.org/2000/svg" class="${baseClass}" viewBox="0 0 20 20" fill="currentColor"><path d="M10.553 2.553a1 1 0 00-1.106 0l-6 4A1 1 0 003 7.382V15a2 2 0 001 1h10a2 2 0 002-2V7.382a1 1 0 00-.447-.829l-6-4z"/></svg>`;
        }
    </script>
    <style>
        /* Estilo base para la fuente Inter y transiciones */
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s; }
        .data-card { transition: transform 0.3s, box-shadow 0.3s; }
        .data-card:hover { transform: translateY(-3px); box-shadow: 0 15px 25px -5px rgba(0, 0, 0, 0.1), 0 5px 10px -5px rgba(0, 0, 0, 0.04); }

        /* Estilos de modo oscuro */
        .dark {
            background-color: #0f172a; /* Fondo muy oscuro */
            color: #e2e8f0; /* Texto claro */
        }
        .dark .bg-white { background-color: #1e293b !important; }
        .dark .text-gray-600 { color: #94a3b8 !important; }
        .dark .text-gray-900 { color: #f1f5f9 !important; }
        .dark .bg-gray-50 { background-color: #0f172a !important; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-slate-900 transition-colors duration-300">

    <!-- BARRA DE NAVEGACI칍N SUPERIOR (HEADER) -->
    <header class="bg-white dark:bg-slate-800 shadow-md sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <!-- Logo/T칤tulo del Portal -->
            <div class="flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gcloud-blue mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M11 3a1 1 0 10-2 0v1a1 1 0 102 0V3zM15.657 5.757a1 1 0 00-1.414 1.414l.707.707a1 1 0 001.414-1.414l-.707-.707zM18 10a1 1 0 00-1-1h-1a1 1 0 100 2h1a1 1 0 001-1zM15.657 14.243l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zM11 17a1 1 0 10-2 0v1a1 1 0 102 0v-1zM4.343 14.243a1 1 0 00-1.414-1.414l-.707.707a1 1 0 001.414 1.414l.707-.707zM3 10a1 1 0 00-1-1H1a1 1 0 100 2h1a1 1 0 001-1zM4.343 5.757l-.707-.707a1 1 0 00-1.414 1.414l.707.707a1 1 0 001.414-1.414z" />
                </svg>
                <span class="text-2xl font-extrabold text-gray-900 dark:text-white">BIGQUERY PORTAL</span>
            </div>
            
            <!-- Barra de B칰squeda y Acciones -->
            <div class="flex items-center space-x-4">
                <!-- Barra de B칰squeda (Oculta en m칩viles, visible en md+) -->
                <div class="hidden md:block relative">
                    <input type="text" placeholder="Buscar datasets, notebooks o autores..." class="w-80 p-2 pl-10 border border-gray-300 dark:border-slate-600 rounded-lg focus:ring-gcloud-blue focus:border-gcloud-blue dark:bg-slate-700 dark:text-white transition duration-150" />
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                </div>
                
                <!-- Toggle de Modo Oscuro -->
                <button id="dark-mode-toggle" class="p-2 rounded-full text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-slate-700 transition duration-150" aria-label="Cambiar Tema">
                    <!-- Icono de Sol / Luna -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 sun-icon dark:hidden" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4.332 2.766a1 1 0 01.32-.21l.71-.237a1 1 0 11.66 1.986l-.71.237a1 1 0 01-.32.21 1 1 0 01-1.076-.214l-.707-.707a1 1 0 01.707-1.707zM18 10a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zM4.332 14.766a1 1 0 01.32-.21l-.71-.237a1 1 0 11.66-1.986l.71.237a1 1 0 01-.32.21 1 1 0 01-1.076.214l-.707.707a1 1 0 01.707 1.707zM10 16a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.757 14.243a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414l-.707.707zM10 14a4 4 0 100-8 4 4 0 000 8z" clip-rule="evenodd" /></svg>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden moon-icon dark:block" viewBox="0 0 20 20" fill="currentColor"><path d="M17.293 17.293a1 1 0 01-1.414 0L10 11.414l-5.879 5.879a1 1 0 01-1.414-1.414L8.586 10 2.707 4.121a1 1 0 111.414-1.414L10 8.586l5.879-5.879a1 1 0 111.414 1.414L11.414 10l5.879 5.879a1 1 0 010 1.414z" /></svg>
                </button>
                
                <!-- Perfil de Usuario -->
                <button class="flex items-center space-x-2 text-gray-800 dark:text-white hover:text-gcloud-blue dark:hover:text-blue-400 transition duration-150">
                    <div class="h-8 w-8 bg-gcloud-blue rounded-full flex items-center justify-center text-white text-sm font-semibold">AR</div>
                    <span class="hidden sm:block text-sm font-medium">Arquitecto</span>
                </button>
            </div>
        </div>
    </header>

    <!-- CONTENIDO PRINCIPAL Y LAYOUT DE DOS COLUMNAS -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="flex flex-col md:flex-row gap-8">
            
            <!-- BARRA LATERAL (SIDEBAR) - NAVEGACI칍N Y FILTROS -->
            <aside class="md:w-64 bg-white dark:bg-slate-800 p-4 rounded-xl shadow-lg border border-gray-100 dark:border-slate-700 md:sticky md:top-20 h-fit">
                <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4 border-b pb-2 dark:border-slate-700">Categor칤as</h3>
                <nav id="sidebar-nav" class="space-y-2"></nav>
                
                <div class="mt-8 pt-4 border-t dark:border-slate-700">
                    <h3 class="text-sm font-bold text-gray-500 dark:text-gray-400 mb-2 uppercase">Herramientas GCloud</h3>
                    <ul class="space-y-1 text-sm text-gray-600 dark:text-gray-400">
                        <li><a href="#" class="hover:text-gcloud-blue transition duration-150">Cloud Run Services</a></li>
                        <li><a href="#" class="hover:text-gcloud-blue transition duration-150">BigQuery Console</a></li>
                        <li><a href="#" class="hover:text-gcloud-blue transition duration-150">Vertex AI Workbench</a></li>
                    </ul>
                </div>
            </aside>

            <!-- 츼REA DE CONTENIDO PRINCIPAL (TARJETAS DE DATOS/ART칈CULOS) -->
            <section class="flex-1 min-w-0" id="content-area">
                <!-- El contenido se inyectar치 aqu칤 mediante JavaScript -->
            </section>
        </div>
    </main>
</body>
</html>
